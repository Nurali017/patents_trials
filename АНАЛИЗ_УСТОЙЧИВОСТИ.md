# Анализ формирования устойчивости

## Общая структура

Устойчивость рассчитывается в классе `ResistanceChecker` (файл `trials_app/evaluation/resistance_checker.py`) методом `calculate_resistance_score()`.

## Процесс формирования устойчивости

### 1. Извлечение данных из базы данных

**Источник данных**: Метод `_get_resistance_indicators()` в `BasicReportService` (файл `trials_app/views/services/basic_report_service.py`)

#### Алгоритм извлечения:

1. **Поиск участников испытаний**:
   - Фильтруются `TrialParticipant` по заявке, региону и годам испытаний
   - Используются только не удаленные записи (`is_deleted=False`)

2. **Поиск показателей устойчивости**:
   - Из таблицы `Indicator` выбираются показатели, содержащие слово "устойчивость" в названии
   - Примеры показателей:
     - `Устойчивость к болезням и вредителям`
     - `Устойчивость к полеганию`
     - `Устойчивость к засухе`
     - `Устойчивость к осыпанию`
     - `Устойчивость к прорастанию на корню`
     - `Устойчивость к пониканию / ломкости колоса`
     - `Зимостойкость`

3. **Получение результатов испытаний**:
   - Из таблицы `TrialResult` выбираются результаты по найденным показателям
   - Фильтрация: `participant`, `indicator`, `is_deleted=False`
   - Используется `select_related('indicator')` для оптимизации запросов

4. **Группировка и усреднение**:
   - Результаты группируются по названию показателя
   - Для каждого показателя вычисляется среднее значение из всех результатов
   - Формула: `avg_value = sum(values) / len(values)`

5. **Преобразование названий для API**:
   - Русские названия преобразуются в английские ключи через метод `_convert_resistance_name()`
   - Маппинг названий:
     - `Устойчивость к болезням и вредителям` → `disease_resistance`
     - `Устойчивость к полеганию` → `lodging_resistance`
     - `Устойчивость к засухе` → `drought_resistance`
     - `Устойчивость к осыпанию` → `shattering_resistance`
     - `Устойчивость к прорастанию на корню` → `sprouting_resistance`
     - `Устойчивость к пониканию / ломкости колоса` → `lodging_resistance`
     - `Устойчивость к цветушности` → `bolting_resistance`

### 2. Структура данных для расчета

Данные передаются в `ResistanceChecker` в следующем формате:

```python
sort_data = {
    'regions_data': [
        {
            'region_id': ...,
            'region_name': ...,
            'resistance_indicators': {
                'disease_resistance': 7.5,      # среднее значение по региону
                'lodging_resistance': 6.0,
                'drought_resistance': 5.5,
                # и т.д.
            }
        },
        # ... другие регионы
    ],
    'summary': {
        'resistance_indicators': {
            # Общие данные по сорту (если есть)
        }
    }
}
```

### 3. Извлечение показателей устойчивости

**Метод**: `_extract_resistance_indicators()` в `ResistanceChecker`

#### Алгоритм:

1. **Сбор показателей из регионов**:
   - Проходим по всем регионам в `regions_data`
   - Извлекаем `resistance_indicators` из каждого региона
   - Накопляем значения по каждому показателю в список

2. **Усреднение по регионам**:
   - Для каждого показателя вычисляем среднее значение из всех регионов
   - Формула: `avg_value = sum(values) / len(values)`
   - Результат округляется до 1 знака после запятой

3. **Добавление общих данных**:
   - Если в `summary.resistance_indicators` есть показатели, которые отсутствуют в региональных данных, они добавляются

**Результат**: Словарь показателей устойчивости с усредненными значениями по всем регионам

```python
{
    'disease_resistance': 7.5,      # среднее по всем регионам
    'lodging_resistance': 6.0,
    'drought_resistance': 5.5,
    # и т.д.
}
```

### 4. Оценка каждого показателя (шкала 1-5 баллов)

**Метод**: `_get_resistance_score()` в `ResistanceChecker`

#### Критерии оценки (по Методике ГСИ):

##### 1. Устойчивость к болезням (`disease_resistance`)
- **5 баллов (Отлично)**: ≥ 9.0
- **4 балла (Хорошо)**: ≥ 7.0
- **3 балла (Удовлетворительно)**: ≥ 5.0
- **2 балла (Посредственно)**: ≥ 3.0
- **1 балл (Плохо)**: < 3.0

##### 2. Устойчивость к полеганию (`lodging_resistance`)
- **5 баллов (Отлично)**: ≥ 7.0
- **4 балла (Хорошо)**: ≥ 5.0
- **3 балла (Удовлетворительно)**: ≥ 3.0
- **2 балла (Посредственно)**: ≥ 1.0
- **1 балл (Плохо)**: < 1.0

##### 3. Засухоустойчивость (`drought_resistance`)
- **5 баллов (Отлично)**: ≥ 7.0
- **4 балла (Хорошо)**: ≥ 5.0
- **3 балла (Удовлетворительно)**: ≥ 3.0
- **2 балла (Посредственно)**: ≥ 1.0
- **1 балл (Плохо)**: < 1.0

##### 4. Зимостойкость (`winter_hardiness`)
- **5 баллов (Отлично)**: ≥ 7.0
- **4 балла (Хорошо)**: ≥ 5.0
- **3 балла (Удовлетворительно)**: ≥ 3.0
- **2 балла (Посредственно)**: ≥ 1.0
- **1 балл (Плохо)**: < 1.0

##### 5. Устойчивость к осыпанию (`shattering_resistance`)
- **5 баллов (Отлично)**: ≥ 7.0
- **4 балла (Хорошо)**: ≥ 5.0
- **3 балла (Удовлетворительно)**: ≥ 3.0
- **2 балла (Посредственно)**: ≥ 1.0
- **1 балл (Плохо)**: < 1.0

##### 6. Устойчивость к прорастанию (`sprouting_resistance`)
- **5 баллов (Отлично)**: ≥ 7.0
- **4 балла (Хорошо)**: ≥ 5.0
- **3 балла (Удовлетворительно)**: ≥ 3.0
- **2 балла (Посредственно)**: ≥ 1.0
- **1 балл (Плохо)**: < 1.0

**Примечание**: Если показатель неизвестен (отсутствует в `resistance_standards`), возвращается средний балл `3`.

### 5. Расчет итогового балла устойчивости

**Метод**: `calculate_resistance_score()` в `ResistanceChecker`

#### Алгоритм расчета:

1. **Проверка наличия данных**:
   - Если показатели отсутствуют → возвращается `None` с флагом `data_available: False`

2. **Оценка каждого показателя**:
   - Для каждого показателя вычисляется балл по шкале 1-5
   - Сохраняется значение показателя, балл и интерпретация

3. **Расчет среднего балла**:
   ```
   avg_score = Σ(баллы_показателей) / количество_показателей
   ```
   - Если нет валидных показателей → используется значение по умолчанию `3.0`

4. **Определение достаточности данных**:
   - `sufficient_data = True` если есть минимум 2 показателя
   - Иначе `sufficient_data = False`

#### Формула:

```
resistance_score = (score_1 + score_2 + ... + score_n) / n
```

где:
- `score_i` - балл i-го показателя (1-5)
- `n` - количество валидных показателей

### 6. Интерпретация результата

**Метод**: `_get_overall_resistance_interpretation()` в `ResistanceChecker`

#### Шкала интерпретации:

- **≥ 4.5**: "Отличная устойчивость к болезням и стрессам"
- **≥ 3.5**: "Хорошая устойчивость"
- **≥ 2.5**: "Удовлетворительная устойчивость"
- **≥ 1.5**: "Слабая устойчивость"
- **< 1.5**: "Очень слабая устойчивость"

### 7. Возвращаемая структура данных

```python
{
    'score': float | None,              # Итоговый балл (1-5), округлен до 0.1
    'interpretation': str,              # Текстовая интерпретация
    'indicators': {                     # Детальные данные по показателям
        'disease_resistance': {
            'value': 7.5,               # Исходное значение (1-10)
            'score': 4,                 # Балл (1-5)
            'interpretation': 'Хорошая устойчивость'
        },
        'lodging_resistance': {
            'value': 6.0,
            'score': 4,
            'interpretation': 'Хорошая устойчивость'
        },
        # ... другие показатели
    },
    'sufficient_data': bool,            # Достаточно ли данных (≥2 показателя)
    'data_available': bool              # Есть ли данные вообще (только если нет данных)
}
```

## Использование в общем балле сорта

### Вес в общем балле

Устойчивость составляет **30%** (0.3) от общего балла сорта.

**Формула общего балла**:
```
overall_score = (yield_score × 0.4 + quality_score × 0.3 + resistance_score × 0.3) / total_weight
```

### Особенности расчета

1. **Отсутствие данных**: 
   - Если `resistance_score = None`, вес устойчивости не учитывается
   - Общий балл рассчитывается только по доступным компонентам

2. **Минимальные требования**:
   - Для одобрения сорта требуется `resistance_score >= 3`
   - Для отклонения критично: `resistance_score <= 2`

3. **Достаточность данных**:
   - Минимум 2 показателя для `sufficient_data = True`
   - Если меньше 2 показателей, данные считаются недостаточными

## Критические показатели

**Метод**: `check_critical_resistance()` в `ResistanceChecker`

### Критические проверки:

1. **Устойчивость к болезням**: критично если < 3.0
2. **Устойчивость к полеганию**: критично если < 3.0
3. **Зимостойкость**: критично если < 3.0

Если хотя бы один критический показатель ниже порога, устанавливается флаг `overall_critical = True`.

## Требования по Методике ГСИ

**Метод**: `get_resistance_requirements()` в `ResistanceChecker`

### Минимальные требования для допуска:

- `disease_resistance`: ≥ 5.0
- `lodging_resistance`: ≥ 4.0
- `drought_resistance`: ≥ 4.0
- `winter_hardiness`: ≥ 4.0

### Отличные стандарты:

- `disease_resistance`: ≥ 9.0
- `lodging_resistance`: ≥ 8.0
- `drought_resistance`: ≥ 8.0
- `winter_hardiness`: ≥ 8.0

## Схема потока данных

```
База данных (TrialResult)
    ↓
BasicReportService._get_resistance_indicators()
    ↓ (усреднение по участникам)
Региональные данные (resistance_indicators)
    ↓
ResistanceChecker._extract_resistance_indicators()
    ↓ (усреднение по регионам)
Общие показатели устойчивости
    ↓
ResistanceChecker._get_resistance_score()
    ↓ (оценка каждого показателя)
Баллы по показателям (1-5)
    ↓
ResistanceChecker.calculate_resistance_score()
    ↓ (средний балл)
Итоговый балл устойчивости
    ↓
BallScorer.calculate_overall_score()
    ↓ (вес 0.3)
Общий балл сорта (30% от устойчивости)
```

## Примеры расчета

### Пример 1: Полные данные

**Данные**:
- Регион 1: `disease_resistance=8.0`, `lodging_resistance=6.0`
- Регион 2: `disease_resistance=7.0`, `lodging_resistance=5.0`

**Расчет**:
1. Усреднение по регионам:
   - `disease_resistance = (8.0 + 7.0) / 2 = 7.5`
   - `lodging_resistance = (6.0 + 5.0) / 2 = 5.5`

2. Оценка показателей:
   - `disease_resistance: 7.5 ≥ 7.0 → 4 балла`
   - `lodging_resistance: 5.5 ≥ 5.0 → 4 балла`

3. Итоговый балл:
   - `resistance_score = (4 + 4) / 2 = 4.0`

**Результат**: 4.0 - "Хорошая устойчивость"

### Пример 2: Недостаточно данных

**Данные**:
- Только один показатель: `disease_resistance=6.0`

**Расчет**:
1. Оценка показателя:
   - `disease_resistance: 6.0 < 7.0, но ≥ 5.0 → 3 балла`

2. Итоговый балл:
   - `resistance_score = 3.0`
   - `sufficient_data = False` (только 1 показатель)

**Результат**: 3.0 - "Удовлетворительная устойчивость", но данных недостаточно

### Пример 3: Отсутствие данных

**Данные**:
- Нет показателей устойчивости

**Результат**:
```python
{
    'score': None,
    'interpretation': 'Данные по устойчивости отсутствуют',
    'sufficient_data': False,
    'data_available': False
}
```

## Файлы, связанные с расчетом устойчивости

1. **`trials_app/evaluation/resistance_checker.py`**
   - Основной класс расчета устойчивости
   - Критерии оценки по Методике ГСИ
   - Методы извлечения и оценки показателей

2. **`trials_app/views/services/basic_report_service.py`**
   - Метод `_get_resistance_indicators()` - извлечение данных из БД
   - Метод `_convert_resistance_name()` - преобразование названий

3. **`trials_app/evaluation/ball_scorer.py`**
   - Использование балла устойчивости в общем балле сорта
   - Вес: 30% от общего балла

4. **`trials_app/models.py`**
   - Модель `TrialResult` - хранение результатов испытаний
   - Модель `Indicator` - справочник показателей

5. **`trials_app/views/services/summary_service.py`**
   - Использование балла устойчивости в годовых отчетах
   - Критерии для рекомендаций по сорту

## Важные замечания

1. **Шкала значений**: Исходные значения показателей - от 1 до 10 баллов (по Методике ГСИ)

2. **Усреднение**: Значения усредняются дважды:
   - По участникам испытаний в регионе
   - По регионам для общего показателя

3. **Обработка отсутствующих данных**: 
   - Если данных нет, балл устойчивости = `None`
   - В общем балле вес устойчивости не учитывается

4. **Достаточность данных**: 
   - Минимум 2 показателя для `sufficient_data = True`
   - Это влияет на надежность оценки

5. **Критические показатели**: 
   - Низкие значения по критическим показателям могут влиять на общую оценку сорта

6. **Методика ГСИ**: 
   - Все критерии оценки основаны на официальной Методике Государственного Сортоиспытания

