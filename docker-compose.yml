services:
  # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL
  trials-db:
    image: postgres:14-alpine
    container_name: trials_postgres
    restart: always
    ports:
      - "5433:5432"  # –ò—Å–ø–æ–ª—å–∑—É–µ–º 5433 —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=qwe1daSjewspds12
      - POSTGRES_DB=trials_db
    volumes:
      - trials_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d trials_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å Trials
  trials-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: trials_service
    command: >
      sh -c "
        echo '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ë–î...' &&
        python manage.py wait_for_db &&
        echo 'üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π...' &&
        python manage.py migrate --noinput &&
        echo 'üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞...' &&
        python manage.py runserver 0.0.0.0:8001
      "
    volumes:
      - .:/usr/src/app/
      - ./volumes/media:/media
    ports:
      - "8001:8001"
    extra_hosts:
      - "host.docker.internal:host-gateway"  # –î–æ—Å—Ç—É–ø –∫ —Ö–æ—Å—Ç-–º–∞—à–∏–Ω–µ
    networks:
      - default
      - patents-backend_default  # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ Patents Service
    environment:
      - DEBUG=1
      - MODE=dev
      - HOST_NAME=localhost
      - SECRET_KEY=trials-secret-key-change-in-production
      - SQL_ENGINE=django.db.backends.postgresql
      - SQL_DATABASE=trials_db
      - SQL_USER=admin
      - SQL_PASSWORD=qwe1daSjewspds12
      - SQL_HOST=trials-db
      - SQL_PORT=5432
      - PATENTS_SERVICE_URL=http://patents-backend-web-1:8000
      - PATENTS_SERVICE_USERNAME=admin
      - PATENTS_SERVICE_PASSWORD=Fx!46hu
    depends_on:
      trials-db:
        condition: service_healthy

networks:
  patents-backend_default:
    external: true  # –í–Ω–µ—à–Ω—è—è —Å–µ—Ç—å –æ—Ç Patents Service

volumes:
  trials_postgres_data:
