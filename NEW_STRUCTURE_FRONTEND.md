# 🎯 Новая структура БД - Гайд для фронтенда

## 📊 Структура БД (4 уровня)

```
1️⃣ TrialPlan (План)
    ↓
2️⃣ TrialPlanCulture (Культура)
    ↓
3️⃣ TrialPlanCultureTrialType (Тип испытания: КСИ/ООС/ДЮС) ⭐ НОВЫЙ УРОВЕНЬ
    ↓
4️⃣ TrialPlanParticipant (Участник/сорт)
    ↓
5️⃣ TrialPlanTrial (Испытания по регионам/ГСУ)
```

---

## 🔄 Последовательность создания плана (для фронтенда)

### Шаг 1️⃣: Создать план испытаний

**Endpoint:** `POST /api/trial-plans/`

```json
{
  "year": 2025,
  "oblast": 1,
  "status": "planned"
}
```

**Ответ:**
```json
{
  "id": 1,
  "year": 2025,
  "oblast": {"id": 1, "name": "Акмолинская"},
  "cultures": []
}
```

> 💡 **Важно:** Сезон теперь задается НЕ на уровне плана, а на уровне типа испытания!

---

### Шаг 2️⃣: Добавить культуру в план

**Endpoint:** `POST /api/trial-plans/{plan_id}/add-culture/`

```json
{
  "culture_id": 21
}
```

**Ответ:**
```json
{
  "id": 1,
  "culture": 21,
  "culture_name": "пшеница",
  "culture_group": "Зерновые"
}
```

---

### Шаг 3️⃣: Добавить ТИП ИСПЫТАНИЯ к культуре ⭐ НОВОЕ

**Endpoint:** `POST /api/trial-plans/{plan_id}/cultures/{culture_id}/add-trial-type/`

```json
{
  "trial_type_id": 1,
  "season": "spring"
}
```

**Где:**
- `trial_type_id`: 
  - `1` = КСИ (Конкурсное сортоиспытание)
  - `2` = ООС (Определение отличительных признаков)
  - `3` = ДЮС
- `season`: `"spring"`, `"autumn"`, `"summer"`, `"winter"`

**Ответ:**
```json
{
  "id": 1,
  "trial_type_id": 1,
  "trial_type_name": "КСИ",
  "season": "spring",
  "participants": []
}
```

> 💡 **Важно:** 
> - Один план культуры может иметь НЕСКОЛЬКО типов испытаний!
> - Каждый тип испытания имеет свой сезон посадки!
> - Например: пшеница КСИ весной + пшеница ООС осенью

---

### Шаг 4️⃣: Добавить участника (сорт) в тип испытания

**Endpoint:** `POST /api/trial-plans/{plan_id}/cultures/{culture_id}/trial-types/{trial_type_id}/add-participants/`

```json
{
  "patents_sort_id": 2241,
  "participant_number": 1,
  "maturity_group": "D03",
  "statistical_group": 1,
  "seeds_provision": "provided",
  "application_id": 27
}
```

**Ответ:**
```json
{
  "id": 1,
  "participant_number": 1,
  "patents_sort_id": 2241,
  "maturity_group": "D03",
  "statistical_group": 1,
  "seeds_provision": "provided",
  "application_id": 27,
  "trials": []
}
```

---

### Шаг 5️⃣: Добавить испытание по региону (ГСУ) для участника

**Endpoint:** `POST /api/trial-plans/{plan_id}/participants/{participant_id}/add-trial/`

```json
{
  "region_id": 122,
  "predecessor": "fallow",
  "seeding_rate": 5.0,
  "season": "spring"
}
```

**Ответ:**
```json
{
  "id": 1,
  "region_id": 122,
  "region_name": "Кербулакский ГСУ",
  "predecessor": "fallow",
  "predecessor_culture_name": "Пар",
  "seeding_rate": 5.0,
  "season": "spring"
}
```

---

## 📋 Получение данных плана

**Endpoint:** `GET /api/trial-plans/{plan_id}/`

**Ответ (новая структура):**
```json
{
  "id": 1,
  "year": 2025,
  "oblast": {
    "id": 1,
    "name": "Акмолинская"
  },
  "cultures": [
    {
      "id": 1,
      "culture": 21,
      "culture_name": "пшеница",
      "culture_group": "Зерновые",
      "trial_types": [
        {
          "id": 1,
          "trial_type_id": 1,
          "trial_type_name": "КСИ",
          "season": "spring",
          "participants": [
            {
              "id": 1,
              "participant_number": 1,
              "patents_sort_id": 2241,
              "maturity_group": "D03",
              "statistical_group": 1,
              "seeds_provision": "provided",
              "application_id": 27,
              "trials": [
                {
                  "id": 1,
                  "region_id": 122,
                  "region_name": "Кербулакский ГСУ",
                  "predecessor": "fallow",
                  "predecessor_culture_name": "Пар",
                  "seeding_rate": 5.0,
                  "season": "spring"
                }
              ]
            }
          ]
        },
        {
          "id": 2,
          "trial_type_id": 2,
          "trial_type_name": "ООС",
          "participants": [...]
        }
      ]
    }
  ]
}
```

---

## 🎨 UI/UX рекомендации для фронтенда

### 1. Страница создания плана

```
┌─────────────────────────────────────────┐
│ Создание плана испытаний                │
├─────────────────────────────────────────┤
│ Год: [2025]                             │
│ Область: [Выбрать область ▼]            │
│ Сезон: [Весна ▼]                        │
│                                         │
│ [Создать план]                          │
└─────────────────────────────────────────┘
```

### 2. Добавление культуры

```
┌─────────────────────────────────────────┐
│ План 2025 - Акмолинская область         │
├─────────────────────────────────────────┤
│ + Добавить культуру                     │
│                                         │
│ Выберите культуру: [Пшеница ▼]          │
│ [Добавить]                              │
└─────────────────────────────────────────┘
```

### 3. Добавление типа испытания ⭐ НОВОЕ

```
┌─────────────────────────────────────────┐
│ Культура: Пшеница                       │
├─────────────────────────────────────────┤
│ Типы испытаний:                         │
│                                         │
│ ☐ КСИ (Конкурсное сортоиспытание)       │
│ ☐ ООС (Отличительные признаки)          │
│ ☐ ДЮС                                   │
│                                         │
│ [Добавить выбранные типы]               │
└─────────────────────────────────────────┘
```

### 4. Добавление участников в тип испытания

```
┌─────────────────────────────────────────┐
│ Пшеница → КСИ                           │
├─────────────────────────────────────────┤
│ + Добавить участника                    │
│                                         │
│ Участники:                              │
│ ┌───────────────────────────────────┐   │
│ │ #1 Сорт ID: 2241                  │   │
│ │    Группа: D03, Статус: Испытываемый│ │
│ │    Регионы: Кербулакский ГСУ      │   │
│ └───────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

---

## 🔑 Ключевые отличия от старой структуры

### ❌ Было (старое):
```
План → Культура → Участник → Испытания (с trial_type на каждом испытании)
```
- Проблема: trial_type повторялся для каждого испытания
- Неудобно группировать КСИ и ООС

### ✅ Стало (новое):
```
План → Культура → Тип испытания → Участник → Испытания
```
- ✅ Тип испытания задается один раз на уровне группы участников
- ✅ Легко разделить КСИ и ООС
- ✅ Логичная иерархия данных

---

## 📝 Примеры сценариев использования

### Сценарий 1: Пшеница проходит только КСИ
```
План 2025 → Пшеница → КСИ → [3 сорта] → [испытания по 5 ГСУ]
```

### Сценарий 2: Пшеница проходит КСИ и ООС
```
План 2025 → Пшеница 
    ├─ КСИ → [10 сортов] → [испытания по 8 ГСУ]
    └─ ООС → [5 новых сортов] → [испытания по 3 ГСУ]
```

### Сценарий 3: Несколько культур в одном плане
```
План 2025 
├─ Пшеница 
│   ├─ КСИ → [10 сортов]
│   └─ ООС → [5 сортов]
└─ Ячмень
    └─ КСИ → [8 сортов]
```

---

## 🔍 Справочники для фронтенда

### Получить список типов испытаний:
```http
GET /api/trial-types/
```

**Ответ:**
```json
[
  {"id": 1, "code": "KSI", "name": "КСИ", "description": "Конкурсное сортоиспытание"},
  {"id": 2, "code": "OOS", "name": "ООС", "description": "Определение отличительных признаков"},
  {"id": 3, "code": "DUS", "name": "ДЮС", "description": "ДЮС испытания"}
]
```

### Получить список культур:
```http
GET /patents/api/cultures/
```

### Получить список областей:
```http
GET /api/oblasts/
```

### Получить список регионов (ГСУ):
```http
GET /api/regions/?oblast={oblast_id}
```

---

## 🎯 Итого для фронтенда

**Порядок действий пользователя:**

1. Создать план (год + область)
2. Добавить культуру(ы)
3. **⭐ Для каждой культуры выбрать типы испытаний (КСИ/ООС/ДЮС)**
4. **⭐ Для каждого типа испытания добавить участников (сорта)**
5. Для каждого участника добавить испытания по регионам (ГСУ)

**Главное изменение:** Теперь между культурой и участниками есть промежуточный уровень - **Тип испытания**.

